# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

jobs:

- job: 'ParallelBuildAndTesting'
  pool: 'Hosted VS2017'
  strategy:
    parallel: 1

  steps:
    - powershell: .\src\build.ps1 -Configuration Release -NoHelp
      displayName: Start Building The Module
      errorActionPreference: continue

    - powershell: .\src\UniversalDashboard.UITest\shebang.tests.ps1 -Release -Integration -Speed
      displayName: Start Integration Tests
      errorActionPreference: continue

    - powershell: invoke-pester .\src\UniversalDashboard.UITest\Integration -CodeCoverage @(".\src\output\UniversalDashboard.psm1",".\src\output\UniversalDashboardServer.psm1",".\src\output\UniversalDashboard.Controls.psm1") -CodeCoverageOutputFile .\src\UniversalDashboard.UITest\test-results\Test-CodeCoverageOutput.xml
      displayName: Start Code Coverage Tests
      errorActionPreference: continue

    - task: PublishTestResults@2
      inputs:
        testResultsFormat: 'NUnit' # Options: JUnit, NUnit, VSTest, xUnit
        testResultsFiles: '**/*TEST-*.xml' 
        searchFolder: '$(System.DefaultWorkingDirectory)' # Optional
        mergeTestResults: true # Optional
        #testRunTitle: 
        #buildPlatform: # Optional
        #buildConfiguration: # Optional
        publishRunAttachments: true # Optional

    - powershell: |
        Compress-Archive -Path .\src\output -DestinationPath .\src\UniversalDashboard.Community.2.1.0.zip -Force -verbose
      displayName: Create OutPut Zip File
      errorActionPreference: continue

    - task: PublishBuildArtifacts@1
      displayName: Publish Artifact
      inputs:
          PathtoPublish: .\src\UniversalDashboard.Community.2.1.0.zip
          ArtifactName: UniversalDashboard.Community.2.1.0
          publishLocation: Container

